<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Scanner Debug Test</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 50px auto; 
            padding: 20px; 
        }
        .debug-section { 
            margin: 20px 0; 
            padding: 20px; 
            border: 1px solid #ccc; 
            border-radius: 8px; 
        }
        button { 
            padding: 10px 15px; 
            margin: 5px; 
            cursor: pointer; 
            border: none; 
            border-radius: 4px; 
            background: #007bff; 
            color: white; 
        }
        button:hover { background: #0056b3; }
        .error { color: #d63031; }
        .success { color: #00b894; }
        .info { color: #0984e3; }
        #video { width: 300px; height: 200px; border: 1px solid #ccc; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; }
        .log { 
            height: 200px; 
            overflow-y: auto; 
            background: #2d3748; 
            color: #e2e8f0; 
            padding: 10px; 
            border-radius: 4px; 
            font-family: monospace; 
        }
    </style>
</head>
<body>
    <h1>üîç QR Scanner Debug & Test</h1>
    <p>This page will help diagnose QR scanning issues step by step.</p>

    <!-- Step 1: Basic Setup Check -->
    <div class="debug-section">
        <h2>Step 1: Basic Setup Check</h2>
        <button onclick="checkBasicSetup()">Check Browser Support</button>
        <div id="setup-result"></div>
    </div>

    <!-- Step 2: Camera Access Test -->
    <div class="debug-section">
        <h2>Step 2: Camera Access Test</h2>
        <button onclick="testCameraAccess()">Test Camera</button>
        <button onclick="stopCamera()">Stop Camera</button>
        <br><br>
        <video id="video" autoplay muted playsinline></video>
        <div id="camera-result"></div>
    </div>

    <!-- Step 3: QR Scanner Library Test -->
    <div class="debug-section">
        <h2>Step 3: QR Scanner Library Test</h2>
        <button onclick="testQRLibrary()">Test QR Scanner Library</button>
        <button onclick="startQRScanner()">Start QR Scanner</button>
        <button onclick="stopQRScanner()">Stop QR Scanner</button>
        <div id="qr-result"></div>
    </div>

    <!-- Step 4: QR Code Generation Test -->
    <div class="debug-section">
        <h2>Step 4: Test QR Codes</h2>
        <button onclick="generateTestQR()">Generate Test QR Code</button>
        <canvas id="qr-canvas" width="200" height="200" style="border: 1px solid #ccc;"></canvas>
        <div id="qr-generate-result"></div>
    </div>

    <!-- Debug Console -->
    <div class="debug-section">
        <h2>Debug Console</h2>
        <button onclick="clearLog()">Clear Log</button>
        <div id="debug-log" class="log"></div>
    </div>

    <!-- Load Libraries -->
    <script type="module">
        // Import QR Scanner using ES6 modules (modern approach)
        let QrScanner, qrScanner;
        let currentStream = null;
        
        // Log function
        function log(message, type = 'info') {
            const logDiv = document.getElementById('debug-log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[QR Debug] ${message}`);
        }

        // Check basic browser support
        window.checkBasicSetup = function() {
            log('Checking basic setup...', 'info');
            
            const results = [];
            
            // Check getUserMedia support
            const hasGetUserMedia = navigator.mediaDevices && navigator.mediaDevices.getUserMedia;
            results.push(`getUserMedia support: ${hasGetUserMedia ? '‚úÖ Yes' : '‚ùå No'}`);
            
            // Check HTTPS/localhost
            const isSecure = location.protocol === 'https:' || location.hostname === 'localhost';
            results.push(`Secure context: ${isSecure ? '‚úÖ Yes' : '‚ùå No (Camera requires HTTPS)'}`);
            
            // Check browser type
            const userAgent = navigator.userAgent;
            let browser = 'Unknown';
            if (userAgent.includes('Chrome')) browser = 'Chrome';
            else if (userAgent.includes('Firefox')) browser = 'Firefox';
            else if (userAgent.includes('Safari')) browser = 'Safari';
            else if (userAgent.includes('Edge')) browser = 'Edge';
            results.push(`Browser: ${browser}`);
            
            // Check device type
            const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(userAgent);
            results.push(`Device: ${isMobile ? 'Mobile' : 'Desktop'}`);
            
            document.getElementById('setup-result').innerHTML = 
                '<h4>Setup Check Results:</h4><ul>' + 
                results.map(r => `<li>${r}</li>`).join('') + 
                '</ul>';
            
            log('Basic setup check completed', 'success');
        };

        // Test camera access
        window.testCameraAccess = async function() {
            log('Testing camera access...', 'info');
            
            try {
                const video = document.getElementById('video');
                
                // Stop existing stream
                if (currentStream) {
                    currentStream.getTracks().forEach(track => track.stop());
                }
                
                // Request camera
                currentStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment', // Try back camera first
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    }
                });
                
                video.srcObject = currentStream;
                
                document.getElementById('camera-result').innerHTML = 
                    '<div class="success">‚úÖ Camera access successful!</div>';
                log('Camera started successfully', 'success');
                
            } catch (error) {
                let errorMsg = `‚ùå Camera error: ${error.message}`;
                
                if (error.name === 'NotAllowedError') {
                    errorMsg += '<br><strong>Solution:</strong> Click allow when browser asks for camera permission';
                } else if (error.name === 'NotFoundError') {
                    errorMsg += '<br><strong>Issue:</strong> No camera found on this device';
                } else if (error.name === 'NotSupportedError') {
                    errorMsg += '<br><strong>Issue:</strong> Camera not supported';
                }
                
                document.getElementById('camera-result').innerHTML = 
                    `<div class="error">${errorMsg}</div>`;
                log(`Camera error: ${error.name} - ${error.message}`, 'error');
            }
        };

        // Stop camera
        window.stopCamera = function() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
                document.getElementById('video').srcObject = null;
                log('Camera stopped', 'info');
            }
        };

        // Test QR Scanner library
        window.testQRLibrary = async function() {
            log('Testing QR Scanner library...', 'info');
            
            try {
                // Try to import QR Scanner
                QrScanner = (await import('https://cdn.jsdelivr.net/npm/qr-scanner@1.4.2/qr-scanner.min.js')).default;
                
                log('QR Scanner library loaded successfully', 'success');
                
                // Test QR Scanner static methods
                const hasCamera = await QrScanner.hasCamera();
                log(`Camera available: ${hasCamera ? 'Yes' : 'No'}`, 'info');
                
                const cameras = await QrScanner.listCameras(true);
                log(`Available cameras: ${cameras.length}`, 'info');
                cameras.forEach((cam, i) => {
                    log(`  Camera ${i + 1}: ${cam.label || 'Unknown'}`, 'info');
                });
                
                document.getElementById('qr-result').innerHTML = 
                    '<div class="success">‚úÖ QR Scanner library test passed!</div>';
                
            } catch (error) {
                log(`QR Scanner library error: ${error.message}`, 'error');
                document.getElementById('qr-result').innerHTML = 
                    `<div class="error">‚ùå QR Scanner library failed: ${error.message}</div>`;
            }
        };

        // Start QR Scanner
        window.startQRScanner = async function() {
            log('Starting QR Scanner...', 'info');
            
            if (!QrScanner) {
                log('QR Scanner library not loaded. Run library test first.', 'error');
                return;
            }
            
            try {
                const video = document.getElementById('video');
                
                qrScanner = new QrScanner(video, result => {
                    log(`QR Code detected: ${result.data}`, 'success');
                    
                    // Try to parse as JSON
                    try {
                        const parsed = JSON.parse(result.data);
                        log(`Parsed QR data: ${JSON.stringify(parsed, null, 2)}`, 'success');
                    } catch {
                        log(`QR data (plain text): ${result.data}`, 'success');
                    }
                    
                    document.getElementById('qr-result').innerHTML += 
                        `<div class="success">‚úÖ QR Code scanned: ${result.data}</div>`;
                }, {
                    onDecodeError: error => {
                        // Don't log decode errors - they happen constantly while scanning
                    },
                    preferredCamera: 'environment',
                    highlightScanRegion: true,
                    highlightCodeOutline: true,
                });
                
                await qrScanner.start();
                log('QR Scanner started successfully', 'success');
                
                document.getElementById('qr-result').innerHTML = 
                    '<div class="success">‚úÖ QR Scanner is running! Point camera at QR code.</div>';
                
            } catch (error) {
                log(`QR Scanner start error: ${error.message}`, 'error');
                document.getElementById('qr-result').innerHTML = 
                    `<div class="error">‚ùå QR Scanner failed: ${error.message}</div>`;
            }
        };

        // Stop QR Scanner
        window.stopQRScanner = function() {
            if (qrScanner) {
                qrScanner.stop();
                qrScanner.destroy();
                qrScanner = null;
                log('QR Scanner stopped', 'info');
            }
        };

        // Generate test QR code
        window.generateTestQR = async function() {
            log('Generating test QR code...', 'info');
            
            try {
                // Import QRCode library
                const QRCode = (await import('https://cdn.jsdelivr.net/npm/qrcode@1.5.4/build/qrcode.min.js')).default;
                
                const testData = {
                    id: 'MED-' + Date.now() + '-TEST',
                    name: 'Test Student',
                    nic: '199501012345V',
                    regNumber: 'MED/2024/TEST001',
                    timestamp: new Date().toISOString(),
                    dataUrl: 'http://localhost:3000/medical-record/test'
                };
                
                const canvas = document.getElementById('qr-canvas');
                await QRCode.toCanvas(canvas, JSON.stringify(testData), {
                    width: 200,
                    height: 200,
                    color: {
                        dark: '#000000',
                        light: '#ffffff'
                    }
                });
                
                log('Test QR code generated successfully', 'success');
                document.getElementById('qr-generate-result').innerHTML = 
                    '<div class="success">‚úÖ Test QR code generated! Try scanning it with the scanner above.</div>';
                
                // Also show the data
                document.getElementById('qr-generate-result').innerHTML += 
                    `<pre>${JSON.stringify(testData, null, 2)}</pre>`;
                
            } catch (error) {
                log(`QR generation error: ${error.message}`, 'error');
                document.getElementById('qr-generate-result').innerHTML = 
                    `<div class="error">‚ùå QR generation failed: ${error.message}</div>`;
            }
        };

        // Clear log
        window.clearLog = function() {
            document.getElementById('debug-log').innerHTML = '';
            log('Log cleared', 'info');
        };

        // Initialize
        log('QR Scanner Debug Tool loaded', 'success');
        log('Click "Check Browser Support" to start debugging', 'info');
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            stopCamera();
            stopQRScanner();
        });
    </script>
</body>
</html>