import React, { useState, useEffect } from 'react';
import './DoctorReport.css';

const DoctorReport = () => {
  const [selectedPatient, setSelectedPatient] = useState(null);
  const [patientData, setPatientData] = useState(null);
  const [hospitalData, setHospitalData] = useState(null);
  const [reportType, setReportType] = useState('detailed');
  const [printMode, setPrintMode] = useState(false);

  // Load selected patient data
  useEffect(() => {
    const stored = localStorage.getItem('selectedPatient');
    if (stored) {
      const patient = JSON.parse(stored);
      setSelectedPatient(patient);
      loadPatientMedicalData(patient.email);
    }
  }, []);

  const loadPatientMedicalData = (email) => {
    // Load student form data (Part 1)
    const studentData = localStorage.getItem(`studentData_${email}`);
    if (studentData) {
      setPatientData(JSON.parse(studentData));
    }

    // Load hospital form data (Part 2)  
    const hospitalFormData = localStorage.getItem(`hospitalData_${email}`);
    if (hospitalFormData) {
      setHospitalData(JSON.parse(hospitalFormData));
    }
  };

  const handlePrint = () => {
    setPrintMode(true);
    setTimeout(() => {
      window.print();
      setPrintMode(false);
    }, 100);
  };

  const getStatusColor = (status) => {
    switch(status?.toLowerCase()) {
      case 'yes': return '#ef4444';
      case 'no': return '#22c55e';
      default: return '#6b7280';
    }
  };

  const formatDate = (dateString) => {
    if (!dateString) return 'Not Provided';
    return new Date(dateString).toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'long',  
      day: 'numeric'
    });
  };

  if (!selectedPatient) {
    return (
      <div className="report-container">
        <div className="no-patient">
          <div className="no-patient-icon">üìã</div>
          <h2>No Patient Selected</h2>
          <p>Please select a patient from the Doctor Dashboard or Queue to view their medical report.</p>
        </div>
      </div>
    );
  }

  return (
    <div className={`report-container ${printMode ? 'print-mode' : ''}`}>
      {/* Header Controls */}
      {!printMode && (
        <div className="report-controls">
          <div className="controls-left">
            <h1>üìã Medical Report</h1>
            <div className="patient-selector">
              <span className="patient-name">{selectedPatient?.studentName || 'Unknown Patient'}</span>
              <span className="queue-number">Queue #{selectedPatient?.queueNo}</span>
            </div>
          </div>
          <div className="controls-right">
            <select 
              value={reportType} 
              onChange={(e) => setReportType(e.target.value)}
              className="report-type-select"
            >
              <option value="detailed">Detailed Report</option>
              <option value="summary">Summary Report</option>
              <option value="prescription">Prescription Only</option>
            </select>
            <button className="print-btn" onClick={handlePrint}>
              üñ®Ô∏è Print Report
            </button>
          </div>
        </div>
      )}

      {/* Medical Report Content */}
      <div className="medical-report">
        {/* Report Header */}
        <div className="report-header">
          <div className="hospital-logo">
            <div className="logo-icon">üè•</div>
            <div className="hospital-info">
              <h1>SmartMed Healthcare System</h1>
              <p>University Medical Center</p>
              <p>Comprehensive Medical Examination Report</p>
            </div>
          </div>
          <div className="report-meta">
            <div className="report-date">
              <strong>Report Date:</strong> {formatDate(new Date().toISOString())}
            </div>
            <div className="report-id">
              <strong>Report ID:</strong> SMH-{selectedPatient?.queueNo || '001'}-{new Date().getFullYear()}
            </div>
          </div>
        </div>

        {/* Patient Information Summary */}
        <div className="report-section patient-overview">
          <h2 className="section-title">Patient Information</h2>
          <div className="patient-info-grid">
            <div className="info-card">
              <h3>Basic Details</h3>
              <div className="info-rows">
                <div className="info-row">
                  <span className="label">Full Name:</span>
                  <span className="value">{patientData?.fullName || selectedPatient?.studentName || 'N/A'}</span>
                </div>
                <div className="info-row">
                  <span className="label">Student ID:</span>
                  <span className="value">{patientData?.studentRegistrationNumber || selectedPatient?.studentId || 'N/A'}</span>
                </div>
                <div className="info-row">
                  <span className="label">NIC:</span>
                  <span className="value">{patientData?.nic || selectedPatient?.nic || 'N/A'}</span>
                </div>
                <div className="info-row">
                  <span className="label">Email:</span>
                  <span className="value">{patientData?.email || selectedPatient?.email || 'N/A'}</span>
                </div>
                <div className="info-row">
                  <span className="label">Phone:</span>
                  <span className="value">{patientData?.telephoneNumber || selectedPatient?.phone || 'N/A'}</span>
                </div>
              </div>
            </div>
            
            <div className="info-card">
              <h3>Personal Details</h3>
              <div className="info-rows">
                <div className="info-row">
                  <span className="label">Age:</span>
                  <span className="value">{patientData?.age || 'N/A'}</span>
                </div>
                <div className="info-row">
                  <span className="label">Date of Birth:</span>
                  <span className="value">{formatDate(patientData?.dateOfBirth)}</span>
                </div>
                <div className="info-row">
                  <span className="label">Gender:</span>
                  <span className="value">{patientData?.gender || 'N/A'}</span>
                </div>
                <div className="info-row">
                  <span className="label">Nationality:</span>
                  <span className="value">{patientData?.nationality || 'N/A'}</span>
                </div>
                <div className="info-row">
                  <span className="label">Academic Division:</span>
                  <span className="value">{patientData?.academicDivision || selectedPatient?.medicalData?.student?.academicDivision || 'N/A'}</span>
                </div>
              </div>
            </div>

            <div className="info-card">
              <h3>Emergency Contact</h3>
              <div className="info-rows">
                <div className="info-row">
                  <span className="label">Name:</span>
                  <span className="value">{patientData?.emergencyName || selectedPatient?.medicalData?.student?.emergencyContact?.name || 'N/A'}</span>
                </div>
                <div className="info-row">
                  <span className="label">Phone:</span>
                  <span className="value">{patientData?.emergencyTelephone || selectedPatient?.medicalData?.student?.emergencyContact?.telephone || 'N/A'}</span>
                </div>
                <div className="info-row">
                  <span className="label">Relationship:</span>
                  <span className="value">{patientData?.emergencyRelationship || 'N/A'}</span>
                </div>
                <div className="info-row">
                  <span className="label">Address:</span>
                  <span className="value">{patientData?.emergencyAddress || 'N/A'}</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        {(reportType === 'detailed' || reportType === 'summary') && (
          <>
            {/* Part 1: Student Medical History */}
            <div className="report-section">
              <h2 className="section-title">Part 1: Student Medical History</h2>
              
              {/* Family Medical History */}
              <div className="subsection">
                <h3>Family Medical History</h3>
                <div className="family-history-table">
                  <div className="table-header">
                    <div>Relation</div>
                    <div>Age</div>
                    <div>Status</div>
                    <div>Notes</div>
                  </div>
                  {patientData?.familyHistory && Object.entries(patientData.familyHistory).map(([relation, data]) => (
                    <div key={relation} className="table-row">
                      <div className="relation">{relation.charAt(0).toUpperCase() + relation.slice(1)}</div>
                      <div>{data.age || 'N/A'}</div>
                      <div className={`status ${data.aliveState ? data.aliveState.replace(' ', '-') : 'unknown'}`}>
                        {data.aliveState || 'Unknown'}
                      </div>
                      <div>{data.causeOfDeath || 'N/A'}</div>
                    </div>
                  ))}
                </div>
              </div>

              {/* Medical Conditions */}
              <div className="subsection">
                <h3>Medical Conditions & History</h3>
                <div className="conditions-grid">
                  {patientData?.medicalHistory && Object.entries(patientData.medicalHistory).map(([condition, data]) => (
                    <div key={condition} className="condition-card">
                      <div className="condition-header">
                        <span className="condition-name">{condition.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())}</span>
                        <span 
                          className={`condition-status ${data.status}`}
                          style={{ backgroundColor: getStatusColor(data.status) }}
                        >
                          {data.status || 'N/A'}
                        </span>
                      </div>
                      {data.status === 'yes' && data.details && (
                        <div className="condition-details">
                          <p>{data.details}</p>
                        </div>
                      )}
                    </div>
                  ))}
                </div>
              </div>

              {/* Vaccination History */}
              <div className="subsection">
                <h3>Vaccination History</h3>
                <div className="vaccination-grid">
                  {patientData?.vaccinations && Object.entries(patientData.vaccinations).map(([vaccine, date]) => (
                    <div key={vaccine} className="vaccination-item">
                      <div className="vaccine-name">{vaccine.toUpperCase()}</div>
                      <div className="vaccine-date">{formatDate(date)}</div>
                      <div className={`vaccine-status ${date ? 'completed' : 'pending'}`}>
                        {date ? ' Completed' : 'L Not Given'}
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            </div>

            {/* Part 2: Medical Officer Examination */}
            <div className="report-section">
              <h2 className="section-title">Part 2: Medical Officer Examination</h2>
              
              {/* Physical Measurements */}
              <div className="subsection">
                <h3>Physical Measurements</h3>
                <div className="measurements-grid">
                  <div className="measurement-card">
                    <div className="measurement-icon"ü¶∑</div>
                    <div className="measurement-value">{hospitalData?.weight || 'N/A'}</div>
                    <div className="measurement-label">Weight (kg)</div>
                  </div>
                  <div className="measurement-card">
                    <div className="measurement-icon">üñ®Ô∏è</div>
                    <div className="measurement-value">{hospitalData?.height || 'N/A'}</div>
                    <div className="measurement-label">Height (cm)</div>
                  </div>
                  <div className="measurement-card">
                    <div className="measurement-icon">ü¶∑</div>
                    <div className="measurement-value">
                      {hospitalData?.chestInspiration ? `${hospitalData.chestInspiration}/${hospitalData.chestExpiration}` : 'N/A'}
                    </div>
                    <div className="measurement-label">Chest (Insp/Exp)</div>
                  </div>
                  <div className="measurement-card">
                    <div className="measurement-icon">>x</div>
                    <div className="measurement-value">{hospitalData?.bloodPressure || 'N/A'}</div>
                    <div className="measurement-label">Blood Pressure</div>
                  </div>
                  <div className="measurement-card">
                    <div className="measurement-icon">üñ®Ô∏è</div>
                    <div className="measurement-value">{hospitalData?.pulse || 'N/A'}</div>
                    <div className="measurement-label">Pulse</div>
                  </div>
                  <div className="measurement-card">
                    <div className="measurement-icon">>x</div>
                    <div className="measurement-value">{hospitalData?.bloodGroup || 'N/A'}</div>
                    <div className="measurement-label">Blood Group</div>
                  </div>
                </div>
              </div>

              {/* System Examinations */}
              <div className="subsection">
                <h3>System Examinations</h3>
                <div className="systems-grid">
                  <div className="system-card">
                    <h4>ü¶∑ Dental Health</h4>
                    <div className="system-findings">
                      <div className="finding">Decayed: {hospitalData?.teethDecayed ? ' Yes' : 'L No'}</div>
                      <div className="finding">Missing: {hospitalData?.teethMissing ? ' Yes' : 'L No'}</div>
                      <div className="finding">Dentures: {hospitalData?.teethDentures ? ' Yes' : 'L No'}</div>
                      <div className="finding">Gingivitis: {hospitalData?.teethGingivitis ? ' Yes' : 'L No'}</div>
                    </div>
                  </div>

                  <div className="system-card">
                    <h4>=B Hearing & Speech</h4>
                    <div className="system-findings">
                      <div className="finding">Right Ear: {hospitalData?.hearingRight || 'N/A'}</div>
                      <div className="finding">Left Ear: {hospitalData?.hearingLeft || 'N/A'}</div>
                      <div className="finding">Speech: {hospitalData?.speech || 'N/A'}</div>
                    </div>
                  </div>

                  <div className="system-card">
                    <h4>d Cardiovascular</h4>
                    <div className="system-findings">
                      <div className="finding">Heart Disease History: {hospitalData?.heartDisease || 'N/A'}</div>
                      <div className="finding">Heart Sound: {hospitalData?.heartSound || 'N/A'}</div>
                      <div className="finding">Murmurs: {hospitalData?.murmurs || 'N/A'}</div>
                    </div>
                  </div>

                  <div className="system-card">
                    <h4>ü¶∑ Respiratory</h4>
                    <div className="system-findings">
                      <div className="finding">TB History: {hospitalData?.tuberculosis || 'N/A'}</div>
                      <div className="finding">TB Test: {hospitalData?.tuberculosisTest || 'N/A'}</div>
                      <div className="finding">X-ray Chest: {hospitalData?.xrayChest || 'N/A'}</div>
                      <div className="finding">X-ray Findings: {hospitalData?.xrayFindings || 'N/A'}</div>
                    </div>
                  </div>

                  <div className="system-card">
                    <h4>=A Vision</h4>
                    <div className="system-findings">
                      <div className="finding">Right Eye (w/o glasses): {hospitalData?.visionRightWithout || 'N/A'}</div>
                      <div className="finding">Left Eye (w/o glasses): {hospitalData?.visionLeftWithout || 'N/A'}</div>
                      <div className="finding">Right Eye (w/ glasses): {hospitalData?.visionRightWith || 'N/A'}</div>
                      <div className="finding">Left Eye (w/ glasses): {hospitalData?.visionLeftWith || 'N/A'}</div>
                      <div className="finding">Color Vision: {hospitalData?.colorVisionNormal ? 'Normal' : 'Impaired'}</div>
                    </div>
                  </div>

                  <div className="system-card">
                    <h4>ü¶∑ Nervous System</h4>
                    <div className="system-findings">
                      <div className="finding">Convulsions: {hospitalData?.convulsion || 'N/A'}</div>
                      <div className="finding">Knee Jerks: {hospitalData?.kneeJerks || 'N/A'}</div>
                    </div>
                  </div>
                </div>
              </div>

              {/* Clinical Tests */}
              <div className="subsection">
                <h3>Clinical Test Results</h3>
                <div className="clinical-tests">
                  <div className="test-result">
                    <span className="test-name">Hemoglobin:</span>
                    <span className="test-value">{hospitalData?.hemoglobin ? `${hospitalData.hemoglobin} g/dL` : 'N/A'}</span>
                  </div>
                  <div className="test-result">
                    <span className="test-name">Blood Group & Rh:</span>
                    <span className="test-value">{hospitalData?.bloodGroup || 'N/A'}</span>
                  </div>
                  <div className="test-result">
                    <span className="test-name">Vaccination Status:</span>
                    <span className="test-value">{hospitalData?.vaccinated === 'yes' ? ' Vaccinated' : 'L Not Vaccinated'}</span>
                  </div>
                </div>
              </div>
            </div>

            {/* Medical Assessment */}
            <div className="report-section">
              <h2 className="section-title">Medical Assessment & Recommendations</h2>
              
              <div className="assessment-grid">
                <div className="assessment-card">
                  <h3>Specialist Referral</h3>
                  <div className={`referral-status ${hospitalData?.specialistReferral}`}>
                    {hospitalData?.specialistReferral === 'yes' ? '‚öïÔ∏è Required' : ' Not Required'}
                  </div>
                  {hospitalData?.specialistReferral === 'yes' && hospitalData?.medicalCondition && (
                    <div className="condition-note">
                      <strong>Condition:</strong> {hospitalData.medicalCondition}
                    </div>
                  )}
                </div>

                <div className="assessment-card">
                  <h3>Fitness Assessment</h3>
                  <div className={`fitness-status ${hospitalData?.fitForStudies}`}>
                    {hospitalData?.fitForStudies === 'fit' ? ' Fit for Studies' : 
                     hospitalData?.fitForStudies === 'not-fit' ? 'L Not Fit for Studies' : 'Assessment Pending'}
                  </div>
                  {hospitalData?.reason && (
                    <div className="reason-note">
                      <strong>Reason:</strong> {hospitalData.reason}
                    </div>
                  )}
                </div>
              </div>
            </div>
          </>
        )}

        {/* Medical Officer Signatures */}
        {hospitalData && (
          <div className="report-section signatures">
            <h2 className="section-title">Medical Officer Verification</h2>
            <div className="signatures-grid">
              <div className="signature-box">
                <div className="signature-label">Medical Officer</div>
                {hospitalData.medicalOfficerSignature ? (
                  <img src={hospitalData.medicalOfficerSignature} alt="Medical Officer Signature" className="signature-image" />
                ) : (
                  <div className="signature-placeholder">Signature not available</div>
                )}
                <div className="signature-date">Date: {formatDate(hospitalData.date1)}</div>
              </div>
              
              <div className="signature-box">
                <div className="signature-label">ITUM Medical Officer</div>
                {hospitalData.itumMedicalOfficerSignature ? (
                  <img src={hospitalData.itumMedicalOfficerSignature} alt="ITUM Medical Officer Signature" className="signature-image" />
                ) : (
                  <div className="signature-placeholder">Signature not available</div>
                )}
                <div className="signature-date">Date: {formatDate(hospitalData.date2)}</div>
              </div>
            </div>
          </div>
        )}

        {/* Report Footer */}
        <div className="report-footer">
          <div className="footer-info">
            <p><strong>Report generated on:</strong> {formatDate(new Date().toISOString())}</p>
            <p><strong>Generated by:</strong> SmartMed Healthcare System</p>
            <p><strong>This report is confidential and for medical use only</strong></p>
          </div>
        </div>
      </div>
    </div>
  );
};

export default DoctorReport;